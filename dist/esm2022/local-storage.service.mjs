import { Inject, Injectable, Optional } from "@angular/core";
import CryptoJS from "crypto-js";
import { Observable, Subscriber } from "rxjs";
import { share } from "rxjs/operators";
import { LOCAL_STORAGE_SERVICE_CONFIG, } from "./local-storage.config.interface";
import * as i0 from "@angular/core";
const DEPRECATED = "This function is deprecated.";
const LOCAL_STORAGE_NOT_SUPPORTED = "LOCAL_STORAGE_NOT_SUPPORTED";
const ENCRYPT_KET_NOT_SET = "To use this function encryptKey must be set!";
export class LocalStorageService {
    isSupported = false;
    errors$;
    removeItems$;
    setItems$;
    warnings$;
    notifyOptions = {
        setItem: false,
        removeItem: false,
    };
    prefix = "ls";
    storageType = "localStorage";
    webStorage;
    encryptData = false;
    key = "";
    errors = new Subscriber();
    removeItems = new Subscriber();
    setItems = new Subscriber();
    warnings = new Subscriber();
    constructor(config = {}) {
        let { notifyOptions, prefix, storageType, encrypt, encryptKey } = config;
        if (notifyOptions != null) {
            let { setItem, removeItem } = notifyOptions;
            this.setNotify(!!setItem, !!removeItem);
        }
        if (encrypt) {
            if (!encryptKey) {
                console.warn(ENCRYPT_KET_NOT_SET);
            }
            else {
                this.setEncryptKey(encryptKey);
            }
        }
        if (prefix != null) {
            this.setPrefix(prefix);
        }
        if (storageType != null) {
            this.setStorageType(storageType);
        }
        this.errors$ = new Observable((observer) => (this.errors = observer)).pipe(share());
        this.removeItems$ = new Observable((observer) => (this.removeItems = observer)).pipe(share());
        this.setItems$ = new Observable((observer) => (this.setItems = observer)).pipe(share());
        this.warnings$ = new Observable((observer) => (this.warnings = observer)).pipe(share());
        this.isSupported = this.checkSupport();
    }
    add(key, value) {
        if (console && console.warn) {
            console.warn(DEPRECATED);
            console.warn("Use `LocalStorageService.set` instead.");
        }
        return this.set(key, value);
    }
    clearAll(regularExpression) {
        // Setting both regular expressions independently
        // Empty strings result in catchall RegExp
        let prefixRegex = !!this.prefix
            ? new RegExp("^" + this.prefix)
            : new RegExp("");
        let testRegex = !!regularExpression
            ? new RegExp(regularExpression)
            : new RegExp("");
        if (!this.isSupported) {
            this.warnings.next(LOCAL_STORAGE_NOT_SUPPORTED);
            return false;
        }
        let prefixLength = this.prefix.length;
        for (let key in this.webStorage) {
            // Only remove items that are for this app and match the regular expression
            if (prefixRegex.test(key) && testRegex.test(key.substr(prefixLength))) {
                try {
                    this.remove(key.substr(prefixLength));
                }
                catch (e) {
                    this.errors.next(e.message);
                    return false;
                }
            }
        }
        return true;
    }
    deriveKey(key) {
        return `${this.prefix}${key}`;
    }
    get(key) {
        if (!this.isSupported) {
            this.warnings.next(LOCAL_STORAGE_NOT_SUPPORTED);
            return null;
        }
        let item = this.webStorage
            ? this.webStorage.getItem(this.deriveKey(key))
            : null;
        // FIXME: not a perfect solution, since a valid 'null' string can't be stored
        if (!item || item === "null") {
            return null;
        }
        try {
            if (this.encryptData) {
                item = this.decrypt(item);
            }
            return JSON.parse(item);
        }
        catch (e) {
            return null;
        }
    }
    getStorageType() {
        return this.storageType;
    }
    keys() {
        if (!this.isSupported) {
            this.warnings.next(LOCAL_STORAGE_NOT_SUPPORTED);
            return [];
        }
        let prefixLength = this.prefix.length;
        let keys = [];
        for (let key in this.webStorage) {
            // Only return keys that are for this app
            if (key.substr(0, prefixLength) === this.prefix) {
                try {
                    keys.push(key.substr(prefixLength));
                }
                catch (e) {
                    this.errors.next(e.message);
                    return [];
                }
            }
        }
        return keys;
    }
    length() {
        let count = 0;
        let storage = this.webStorage;
        for (let i = 0; i < storage.length; i++) {
            if (storage.key(i).indexOf(this.prefix) === 0) {
                count += 1;
            }
        }
        return count;
    }
    remove(...keys) {
        let result = true;
        keys.forEach((key) => {
            if (!this.isSupported) {
                this.warnings.next(LOCAL_STORAGE_NOT_SUPPORTED);
                result = false;
            }
            try {
                this.webStorage.removeItem(this.deriveKey(key));
                if (this.notifyOptions.removeItem) {
                    this.removeItems.next({
                        key: key,
                        storageType: this.storageType,
                    });
                }
            }
            catch (e) {
                this.errors.next(e.message);
                result = false;
            }
        });
        return result;
    }
    set(key, value) {
        // Let's convert `undefined` values to `null` to get the value consistent
        if (value === undefined) {
            value = null;
        }
        else {
            value = JSON.stringify(value);
            if (this.encryptData) {
                value = this.encrypt(value);
            }
        }
        if (!this.isSupported) {
            this.warnings.next(LOCAL_STORAGE_NOT_SUPPORTED);
            return false;
        }
        try {
            if (this.webStorage) {
                this.webStorage.setItem(this.deriveKey(key), value);
            }
            if (this.notifyOptions.setItem) {
                this.setItems.next({
                    key: key,
                    newvalue: value,
                    storageType: this.storageType,
                });
            }
        }
        catch (e) {
            this.errors.next(e.message);
            return false;
        }
        return true;
    }
    checkSupport() {
        try {
            let supported = this.storageType in window && window[this.storageType] !== null;
            if (supported) {
                this.webStorage = window[this.storageType];
                // When Safari (OS X or iOS) is in private browsing mode, it
                // appears as though localStorage is available, but trying to
                // call .setItem throws an exception.
                //
                // "QUOTA_EXCEEDED_ERR: DOM Exception 22: An attempt was made
                // to add something to storage that exceeded the quota."
                let key = this.deriveKey(`__${Math.round(Math.random() * 1e7)}`);
                this.webStorage.setItem(key, "");
                this.webStorage.removeItem(key);
            }
            return supported;
        }
        catch (e) {
            this.errors.next(e.message);
            return false;
        }
    }
    setEncryptKey(key) {
        this.encryptData = true;
        this.key = key;
    }
    setPrefix(prefix) {
        this.prefix = prefix;
        // If there is a prefix set in the config let's use that with an appended
        // period for readability:
        const PERIOD = ".";
        if (this.prefix && !this.prefix.endsWith(PERIOD)) {
            this.prefix = !!this.prefix ? `${this.prefix}${PERIOD}` : "";
        }
    }
    setStorageType(storageType) {
        this.storageType = storageType;
    }
    setNotify(setItem, removeItem) {
        if (setItem != null) {
            this.notifyOptions.setItem = setItem;
        }
        if (removeItem != null) {
            this.notifyOptions.removeItem = removeItem;
        }
    }
    encrypt(txt) {
        return CryptoJS.AES.encrypt(txt, this.key).toString();
    }
    decrypt(txtToDecrypt) {
        return CryptoJS.AES.decrypt(txtToDecrypt, this.key).toString(CryptoJS.enc.Utf8);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.5", ngImport: i0, type: LocalStorageService, deps: [{ token: LOCAL_STORAGE_SERVICE_CONFIG, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.5", ngImport: i0, type: LocalStorageService, providedIn: "root" });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.5", ngImport: i0, type: LocalStorageService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [LOCAL_STORAGE_SERVICE_CONFIG]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWwtc3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xvY2FsLXN0b3JhZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxRQUFRLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV2QyxPQUFPLEVBRUwsNEJBQTRCLEdBQzdCLE1BQU0sa0NBQWtDLENBQUM7O0FBRzFDLE1BQU0sVUFBVSxHQUFXLDhCQUE4QixDQUFDO0FBQzFELE1BQU0sMkJBQTJCLEdBQVcsNkJBQTZCLENBQUM7QUFDMUUsTUFBTSxtQkFBbUIsR0FDdkIsOENBQThDLENBQUM7QUFLakQsTUFBTSxPQUFPLG1CQUFtQjtJQUN2QixXQUFXLEdBQVksS0FBSyxDQUFDO0lBRTdCLE9BQU8sQ0FBcUI7SUFDNUIsWUFBWSxDQUFpQztJQUM3QyxTQUFTLENBQWlDO0lBQzFDLFNBQVMsQ0FBcUI7SUFFN0IsYUFBYSxHQUFtQjtRQUN0QyxPQUFPLEVBQUUsS0FBSztRQUNkLFVBQVUsRUFBRSxLQUFLO0tBQ2xCLENBQUM7SUFDTSxNQUFNLEdBQVcsSUFBSSxDQUFDO0lBQ3RCLFdBQVcsR0FBc0MsY0FBYyxDQUFDO0lBQ2hFLFVBQVUsQ0FBVTtJQUVwQixXQUFXLEdBQVksS0FBSyxDQUFDO0lBQzdCLEdBQUcsR0FBVyxFQUFFLENBQUM7SUFFakIsTUFBTSxHQUF1QixJQUFJLFVBQVUsRUFBVSxDQUFDO0lBQ3RELFdBQVcsR0FDakIsSUFBSSxVQUFVLEVBQXNCLENBQUM7SUFDL0IsUUFBUSxHQUNkLElBQUksVUFBVSxFQUFzQixDQUFDO0lBQy9CLFFBQVEs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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IENyeXB0b0pTIGZyb20gXCJjcnlwdG8tanNcIjtcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmliZXIgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgc2hhcmUgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IElMb2NhbFN0b3JhZ2VFdmVudCB9IGZyb20gXCIuL2xvY2FsLXN0b3JhZ2UtZXZlbnRzLmludGVyZmFjZVwiO1xuaW1wb3J0IHtcbiAgSUxvY2FsU3RvcmFnZVNlcnZpY2VDb25maWcsXG4gIExPQ0FMX1NUT1JBR0VfU0VSVklDRV9DT05GSUcsXG59IGZyb20gXCIuL2xvY2FsLXN0b3JhZ2UuY29uZmlnLmludGVyZmFjZVwiO1xuaW1wb3J0IHsgSU5vdGlmeU9wdGlvbnMgfSBmcm9tIFwiLi9ub3RpZnktb3B0aW9ucy5pbnRlcmZhY2VcIjtcblxuY29uc3QgREVQUkVDQVRFRDogc3RyaW5nID0gXCJUaGlzIGZ1bmN0aW9uIGlzIGRlcHJlY2F0ZWQuXCI7XG5jb25zdCBMT0NBTF9TVE9SQUdFX05PVF9TVVBQT1JURUQ6IHN0cmluZyA9IFwiTE9DQUxfU1RPUkFHRV9OT1RfU1VQUE9SVEVEXCI7XG5jb25zdCBFTkNSWVBUX0tFVF9OT1RfU0VUOiBzdHJpbmcgPVxuICBcIlRvIHVzZSB0aGlzIGZ1bmN0aW9uIGVuY3J5cHRLZXkgbXVzdCBiZSBzZXQhXCI7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogXCJyb290XCIsXG59KVxuZXhwb3J0IGNsYXNzIExvY2FsU3RvcmFnZVNlcnZpY2Uge1xuICBwdWJsaWMgaXNTdXBwb3J0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwdWJsaWMgZXJyb3JzJDogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuICBwdWJsaWMgcmVtb3ZlSXRlbXMkOiBPYnNlcnZhYmxlPElMb2NhbFN0b3JhZ2VFdmVudD47XG4gIHB1YmxpYyBzZXRJdGVtcyQ6IE9ic2VydmFibGU8SUxvY2FsU3RvcmFnZUV2ZW50PjtcbiAgcHVibGljIHdhcm5pbmdzJDogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG4gIHByaXZhdGUgbm90aWZ5T3B0aW9uczogSU5vdGlmeU9wdGlvbnMgPSB7XG4gICAgc2V0SXRlbTogZmFsc2UsXG4gICAgcmVtb3ZlSXRlbTogZmFsc2UsXG4gIH07XG4gIHByaXZhdGUgcHJlZml4OiBzdHJpbmcgPSBcImxzXCI7XG4gIHByaXZhdGUgc3RvcmFnZVR5cGU6IFwic2Vzc2lvblN0b3JhZ2VcIiB8IFwibG9jYWxTdG9yYWdlXCIgPSBcImxvY2FsU3RvcmFnZVwiO1xuICBwcml2YXRlIHdlYlN0b3JhZ2U6IFN0b3JhZ2U7XG5cbiAgcHJpdmF0ZSBlbmNyeXB0RGF0YTogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIGtleTogc3RyaW5nID0gXCJcIjtcblxuICBwcml2YXRlIGVycm9yczogU3Vic2NyaWJlcjxzdHJpbmc+ID0gbmV3IFN1YnNjcmliZXI8c3RyaW5nPigpO1xuICBwcml2YXRlIHJlbW92ZUl0ZW1zOiBTdWJzY3JpYmVyPElMb2NhbFN0b3JhZ2VFdmVudD4gPVxuICAgIG5ldyBTdWJzY3JpYmVyPElMb2NhbFN0b3JhZ2VFdmVudD4oKTtcbiAgcHJpdmF0ZSBzZXRJdGVtczogU3Vic2NyaWJlcjxJTG9jYWxTdG9yYWdlRXZlbnQ+ID1cbiAgICBuZXcgU3Vic2NyaWJlcjxJTG9jYWxTdG9yYWdlRXZlbnQ+KCk7XG4gIHByaXZhdGUgd2FybmluZ3M6IFN1YnNjcmliZXI8c3RyaW5nPiA9IG5ldyBTdWJzY3JpYmVyPHN0cmluZz4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoTE9DQUxfU1RPUkFHRV9TRVJWSUNFX0NPTkZJRylcbiAgICBjb25maWc6IElMb2NhbFN0b3JhZ2VTZXJ2aWNlQ29uZmlnID0ge31cbiAgKSB7XG4gICAgbGV0IHsgbm90aWZ5T3B0aW9ucywgcHJlZml4LCBzdG9yYWdlVHlwZSwgZW5jcnlwdCwgZW5jcnlwdEtleSB9ID0gY29uZmlnO1xuXG4gICAgaWYgKG5vdGlmeU9wdGlvbnMgIT0gbnVsbCkge1xuICAgICAgbGV0IHsgc2V0SXRlbSwgcmVtb3ZlSXRlbSB9ID0gbm90aWZ5T3B0aW9ucztcbiAgICAgIHRoaXMuc2V0Tm90aWZ5KCEhc2V0SXRlbSwgISFyZW1vdmVJdGVtKTtcbiAgICB9XG5cbiAgICBpZiAoZW5jcnlwdCkge1xuICAgICAgaWYgKCFlbmNyeXB0S2V5KSB7XG4gICAgICAgIGNvbnNvbGUud2FybihFTkNSWVBUX0tFVF9OT1RfU0VUKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2V0RW5jcnlwdEtleShlbmNyeXB0S2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocHJlZml4ICE9IG51bGwpIHtcbiAgICAgIHRoaXMuc2V0UHJlZml4KHByZWZpeCk7XG4gICAgfVxuXG4gICAgaWYgKHN0b3JhZ2VUeXBlICE9IG51bGwpIHtcbiAgICAgIHRoaXMuc2V0U3RvcmFnZVR5cGUoc3RvcmFnZVR5cGUpO1xuICAgIH1cblxuICAgIHRoaXMuZXJyb3JzJCA9IG5ldyBPYnNlcnZhYmxlPHN0cmluZz4oXG4gICAgICAob2JzZXJ2ZXI6IFN1YnNjcmliZXI8c3RyaW5nPikgPT4gKHRoaXMuZXJyb3JzID0gb2JzZXJ2ZXIpXG4gICAgKS5waXBlKHNoYXJlKCkpO1xuXG4gICAgdGhpcy5yZW1vdmVJdGVtcyQgPSBuZXcgT2JzZXJ2YWJsZTxJTG9jYWxTdG9yYWdlRXZlbnQ+KFxuICAgICAgKG9ic2VydmVyOiBTdWJzY3JpYmVyPElMb2NhbFN0b3JhZ2VFdmVudD4pID0+XG4gICAgICAgICh0aGlzLnJlbW92ZUl0ZW1zID0gb2JzZXJ2ZXIpXG4gICAgKS5waXBlKHNoYXJlKCkpO1xuXG4gICAgdGhpcy5zZXRJdGVtcyQgPSBuZXcgT2JzZXJ2YWJsZTxJTG9jYWxTdG9yYWdlRXZlbnQ+KFxuICAgICAgKG9ic2VydmVyOiBTdWJzY3JpYmVyPElMb2NhbFN0b3JhZ2VFdmVudD4pID0+ICh0aGlzLnNldEl0ZW1zID0gb2JzZXJ2ZXIpXG4gICAgKS5waXBlKHNoYXJlKCkpO1xuXG4gICAgdGhpcy53YXJuaW5ncyQgPSBuZXcgT2JzZXJ2YWJsZTxzdHJpbmc+KFxuICAgICAgKG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZz4pID0+ICh0aGlzLndhcm5pbmdzID0gb2JzZXJ2ZXIpXG4gICAgKS5waXBlKHNoYXJlKCkpO1xuXG4gICAgdGhpcy5pc1N1cHBvcnRlZCA9IHRoaXMuY2hlY2tTdXBwb3J0KCk7XG4gIH1cblxuICBwdWJsaWMgYWRkKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgaWYgKGNvbnNvbGUgJiYgY29uc29sZS53YXJuKSB7XG4gICAgICBjb25zb2xlLndhcm4oREVQUkVDQVRFRCk7XG4gICAgICBjb25zb2xlLndhcm4oXCJVc2UgYExvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0YCBpbnN0ZWFkLlwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZXQoa2V5LCB2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgY2xlYXJBbGwocmVndWxhckV4cHJlc3Npb24/OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBTZXR0aW5nIGJvdGggcmVndWxhciBleHByZXNzaW9ucyBpbmRlcGVuZGVudGx5XG4gICAgLy8gRW1wdHkgc3RyaW5ncyByZXN1bHQgaW4gY2F0Y2hhbGwgUmVnRXhwXG4gICAgbGV0IHByZWZpeFJlZ2V4ID0gISF0aGlzLnByZWZpeFxuICAgICAgPyBuZXcgUmVnRXhwKFwiXlwiICsgdGhpcy5wcmVmaXgpXG4gICAgICA6IG5ldyBSZWdFeHAoXCJcIik7XG5cbiAgICBsZXQgdGVzdFJlZ2V4ID0gISFyZWd1bGFyRXhwcmVzc2lvblxuICAgICAgPyBuZXcgUmVnRXhwKHJlZ3VsYXJFeHByZXNzaW9uKVxuICAgICAgOiBuZXcgUmVnRXhwKFwiXCIpO1xuXG4gICAgaWYgKCF0aGlzLmlzU3VwcG9ydGVkKSB7XG4gICAgICB0aGlzLndhcm5pbmdzLm5leHQoTE9DQUxfU1RPUkFHRV9OT1RfU1VQUE9SVEVEKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgcHJlZml4TGVuZ3RoID0gdGhpcy5wcmVmaXgubGVuZ3RoO1xuXG4gICAgZm9yIChsZXQga2V5IGluIHRoaXMud2ViU3RvcmFnZSkge1xuICAgICAgLy8gT25seSByZW1vdmUgaXRlbXMgdGhhdCBhcmUgZm9yIHRoaXMgYXBwIGFuZCBtYXRjaCB0aGUgcmVndWxhciBleHByZXNzaW9uXG4gICAgICBpZiAocHJlZml4UmVnZXgudGVzdChrZXkpICYmIHRlc3RSZWdleC50ZXN0KGtleS5zdWJzdHIocHJlZml4TGVuZ3RoKSkpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLnJlbW92ZShrZXkuc3Vic3RyKHByZWZpeExlbmd0aCkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgdGhpcy5lcnJvcnMubmV4dChlLm1lc3NhZ2UpO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGRlcml2ZUtleShrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke3RoaXMucHJlZml4fSR7a2V5fWA7XG4gIH1cblxuICBwdWJsaWMgZ2V0PFQ+KGtleTogc3RyaW5nKTogVCB7XG4gICAgaWYgKCF0aGlzLmlzU3VwcG9ydGVkKSB7XG4gICAgICB0aGlzLndhcm5pbmdzLm5leHQoTE9DQUxfU1RPUkFHRV9OT1RfU1VQUE9SVEVEKTtcblxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgbGV0IGl0ZW0gPSB0aGlzLndlYlN0b3JhZ2VcbiAgICAgID8gdGhpcy53ZWJTdG9yYWdlLmdldEl0ZW0odGhpcy5kZXJpdmVLZXkoa2V5KSlcbiAgICAgIDogbnVsbDtcblxuICAgIC8vIEZJWE1FOiBub3QgYSBwZXJmZWN0IHNvbHV0aW9uLCBzaW5jZSBhIHZhbGlkICdudWxsJyBzdHJpbmcgY2FuJ3QgYmUgc3RvcmVkXG4gICAgaWYgKCFpdGVtIHx8IGl0ZW0gPT09IFwibnVsbFwiKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMuZW5jcnlwdERhdGEpIHtcbiAgICAgICAgaXRlbSA9IHRoaXMuZGVjcnlwdChpdGVtKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoaXRlbSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFN0b3JhZ2VUeXBlKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmFnZVR5cGU7XG4gIH1cblxuICBwdWJsaWMga2V5cygpOiBBcnJheTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuaXNTdXBwb3J0ZWQpIHtcbiAgICAgIHRoaXMud2FybmluZ3MubmV4dChMT0NBTF9TVE9SQUdFX05PVF9TVVBQT1JURUQpO1xuXG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgbGV0IHByZWZpeExlbmd0aCA9IHRoaXMucHJlZml4Lmxlbmd0aDtcbiAgICBsZXQga2V5czogQXJyYXk8c3RyaW5nPiA9IFtdO1xuICAgIGZvciAobGV0IGtleSBpbiB0aGlzLndlYlN0b3JhZ2UpIHtcbiAgICAgIC8vIE9ubHkgcmV0dXJuIGtleXMgdGhhdCBhcmUgZm9yIHRoaXMgYXBwXG4gICAgICBpZiAoa2V5LnN1YnN0cigwLCBwcmVmaXhMZW5ndGgpID09PSB0aGlzLnByZWZpeCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGtleXMucHVzaChrZXkuc3Vic3RyKHByZWZpeExlbmd0aCkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgdGhpcy5lcnJvcnMubmV4dChlLm1lc3NhZ2UpO1xuXG4gICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGtleXM7XG4gIH1cblxuICBwdWJsaWMgbGVuZ3RoKCk6IG51bWJlciB7XG4gICAgbGV0IGNvdW50ID0gMDtcbiAgICBsZXQgc3RvcmFnZSA9IHRoaXMud2ViU3RvcmFnZTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0b3JhZ2UubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChzdG9yYWdlLmtleShpKS5pbmRleE9mKHRoaXMucHJlZml4KSA9PT0gMCkge1xuICAgICAgICBjb3VudCArPSAxO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb3VudDtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmUoLi4ua2V5czogQXJyYXk8c3RyaW5nPik6IGJvb2xlYW4ge1xuICAgIGxldCByZXN1bHQgPSB0cnVlO1xuXG4gICAga2V5cy5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKCF0aGlzLmlzU3VwcG9ydGVkKSB7XG4gICAgICAgIHRoaXMud2FybmluZ3MubmV4dChMT0NBTF9TVE9SQUdFX05PVF9TVVBQT1JURUQpO1xuICAgICAgICByZXN1bHQgPSBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy53ZWJTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5kZXJpdmVLZXkoa2V5KSk7XG4gICAgICAgIGlmICh0aGlzLm5vdGlmeU9wdGlvbnMucmVtb3ZlSXRlbSkge1xuICAgICAgICAgIHRoaXMucmVtb3ZlSXRlbXMubmV4dCh7XG4gICAgICAgICAgICBrZXk6IGtleSxcbiAgICAgICAgICAgIHN0b3JhZ2VUeXBlOiB0aGlzLnN0b3JhZ2VUeXBlLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRoaXMuZXJyb3JzLm5leHQoZS5tZXNzYWdlKTtcbiAgICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHVibGljIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgIC8vIExldCdzIGNvbnZlcnQgYHVuZGVmaW5lZGAgdmFsdWVzIHRvIGBudWxsYCB0byBnZXQgdGhlIHZhbHVlIGNvbnNpc3RlbnRcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YWx1ZSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcblxuICAgICAgaWYgKHRoaXMuZW5jcnlwdERhdGEpIHtcbiAgICAgICAgdmFsdWUgPSB0aGlzLmVuY3J5cHQodmFsdWUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghdGhpcy5pc1N1cHBvcnRlZCkge1xuICAgICAgdGhpcy53YXJuaW5ncy5uZXh0KExPQ0FMX1NUT1JBR0VfTk9UX1NVUFBPUlRFRCk7XG5cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMud2ViU3RvcmFnZSkge1xuICAgICAgICB0aGlzLndlYlN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmRlcml2ZUtleShrZXkpLCB2YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLm5vdGlmeU9wdGlvbnMuc2V0SXRlbSkge1xuICAgICAgICB0aGlzLnNldEl0ZW1zLm5leHQoe1xuICAgICAgICAgIGtleToga2V5LFxuICAgICAgICAgIG5ld3ZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICBzdG9yYWdlVHlwZTogdGhpcy5zdG9yYWdlVHlwZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5lcnJvcnMubmV4dChlLm1lc3NhZ2UpO1xuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrU3VwcG9ydCgpOiBib29sZWFuIHtcbiAgICB0cnkge1xuICAgICAgbGV0IHN1cHBvcnRlZCA9XG4gICAgICAgIHRoaXMuc3RvcmFnZVR5cGUgaW4gd2luZG93ICYmIHdpbmRvd1t0aGlzLnN0b3JhZ2VUeXBlXSAhPT0gbnVsbDtcblxuICAgICAgaWYgKHN1cHBvcnRlZCkge1xuICAgICAgICB0aGlzLndlYlN0b3JhZ2UgPSB3aW5kb3dbdGhpcy5zdG9yYWdlVHlwZV07XG5cbiAgICAgICAgLy8gV2hlbiBTYWZhcmkgKE9TIFggb3IgaU9TKSBpcyBpbiBwcml2YXRlIGJyb3dzaW5nIG1vZGUsIGl0XG4gICAgICAgIC8vIGFwcGVhcnMgYXMgdGhvdWdoIGxvY2FsU3RvcmFnZSBpcyBhdmFpbGFibGUsIGJ1dCB0cnlpbmcgdG9cbiAgICAgICAgLy8gY2FsbCAuc2V0SXRlbSB0aHJvd3MgYW4gZXhjZXB0aW9uLlxuICAgICAgICAvL1xuICAgICAgICAvLyBcIlFVT1RBX0VYQ0VFREVEX0VSUjogRE9NIEV4Y2VwdGlvbiAyMjogQW4gYXR0ZW1wdCB3YXMgbWFkZVxuICAgICAgICAvLyB0byBhZGQgc29tZXRoaW5nIHRvIHN0b3JhZ2UgdGhhdCBleGNlZWRlZCB0aGUgcXVvdGEuXCJcbiAgICAgICAgbGV0IGtleSA9IHRoaXMuZGVyaXZlS2V5KGBfXyR7TWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogMWU3KX1gKTtcbiAgICAgICAgdGhpcy53ZWJTdG9yYWdlLnNldEl0ZW0oa2V5LCBcIlwiKTtcbiAgICAgICAgdGhpcy53ZWJTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHN1cHBvcnRlZDtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmVycm9ycy5uZXh0KGUubWVzc2FnZSk7XG5cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEVuY3J5cHRLZXkoa2V5OiBzdHJpbmcpIHtcbiAgICB0aGlzLmVuY3J5cHREYXRhID0gdHJ1ZTtcblxuICAgIHRoaXMua2V5ID0ga2V5O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQcmVmaXgocHJlZml4OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnByZWZpeCA9IHByZWZpeDtcblxuICAgIC8vIElmIHRoZXJlIGlzIGEgcHJlZml4IHNldCBpbiB0aGUgY29uZmlnIGxldCdzIHVzZSB0aGF0IHdpdGggYW4gYXBwZW5kZWRcbiAgICAvLyBwZXJpb2QgZm9yIHJlYWRhYmlsaXR5OlxuICAgIGNvbnN0IFBFUklPRDogc3RyaW5nID0gXCIuXCI7XG5cbiAgICBpZiAodGhpcy5wcmVmaXggJiYgIXRoaXMucHJlZml4LmVuZHNXaXRoKFBFUklPRCkpIHtcbiAgICAgIHRoaXMucHJlZml4ID0gISF0aGlzLnByZWZpeCA/IGAke3RoaXMucHJlZml4fSR7UEVSSU9EfWAgOiBcIlwiO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXRTdG9yYWdlVHlwZShzdG9yYWdlVHlwZTogXCJzZXNzaW9uU3RvcmFnZVwiIHwgXCJsb2NhbFN0b3JhZ2VcIik6IHZvaWQge1xuICAgIHRoaXMuc3RvcmFnZVR5cGUgPSBzdG9yYWdlVHlwZTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Tm90aWZ5KHNldEl0ZW06IGJvb2xlYW4sIHJlbW92ZUl0ZW06IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAoc2V0SXRlbSAhPSBudWxsKSB7XG4gICAgICB0aGlzLm5vdGlmeU9wdGlvbnMuc2V0SXRlbSA9IHNldEl0ZW07XG4gICAgfVxuXG4gICAgaWYgKHJlbW92ZUl0ZW0gIT0gbnVsbCkge1xuICAgICAgdGhpcy5ub3RpZnlPcHRpb25zLnJlbW92ZUl0ZW0gPSByZW1vdmVJdGVtO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZW5jcnlwdCh0eHQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIENyeXB0b0pTLkFFUy5lbmNyeXB0KHR4dCwgdGhpcy5rZXkpLnRvU3RyaW5nKCk7XG4gIH1cblxuICBwcml2YXRlIGRlY3J5cHQodHh0VG9EZWNyeXB0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gQ3J5cHRvSlMuQUVTLmRlY3J5cHQodHh0VG9EZWNyeXB0LCB0aGlzLmtleSkudG9TdHJpbmcoXG4gICAgICBDcnlwdG9KUy5lbmMuVXRmOFxuICAgICk7XG4gIH1cbn1cbiJdfQ==